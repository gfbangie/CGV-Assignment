<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }

		</style>
	</head>
	<body>

		<script src="js/three.js"></script>

		<script src="js/OrbitControls.js"></script>
		<script src="js/physi.js"></script>
		<script src="js/GLTFLoader.js"></script>
		<script src="js/perlin_noise.js"></script>
		<script src="js/ammo.js"></script>
		<script src="js/THREEBSP.js"></script>

		<script>

				Physijs.scripts.worker='js/physijs_worker.js';
				//Physijs.scripts.ammo='ammo.js';
				var damping=0.7;
				var friction=0.9;//high
				var scene=new Physijs.Scene; //Scene physics

				scene.setGravity(new THREE.Vector3(0,-10,0));//gravity for scene

				//loads the sky material
				var loader=new THREE.TextureLoader();
				var mat=loader.load('textures/sky.jpg');
				var cubeMat=new THREE.MeshBasicMaterial({map:mat,side:THREE.DoubleSide});
				scene.background=mat;

				//creates camera and positions it
				var camera=new THREE.PerspectiveCamera(40,window.innerWidth/window.innerHeight,0.1,1000);
				camera.rotation.y=-Math.PI/2;
				camera.position.x=-160;
				camera.position.y=50;

				camera.lookAt(scene.position);




				//renderer that renders our actual screen
				 var renderer=new THREE.WebGLRenderer({antialias:true});
				renderer.setSize(window.innerWidth,window.innerHeight);
				document.body.appendChild(renderer.domElement);
				//resize screen based on window size
				window.addEventListener('resize',()=>{
					renderer.setSize( window.innerWidth, window.innerHeight );
				 	camera.aspect=window.innerWidth / window.innerHeight;
				 	camera.updateProjectionMatrix();
				});


				//function to add random spheres to screen
				function add_sphere(){
					var sphereGeometry=new THREE.SphereGeometry(1,20,20);
					var load=new THREE.TextureLoader();
					var mat=load.load('textures/crate.gif');

					var sphereMat=new THREE.MeshBasicMaterial({map:mat});
					var sphere=new Physijs.BoxMesh(sphereGeometry,sphereMat);
					sphere.scale.set(15,15,15);
					sphere.position.x=100*Math.random();
					sphere.position.y=100;
					sphere.__dirtyPosition=true;
					scene.add(sphere);
				}

				//creates Land that we drive on
				function createLand(){
					var ground_material, ground_geometry,sun, ground;

					var loader=new THREE.TextureLoader();
					var mat=loader.load('textures/sky.jpg');
					ground_material = Physijs.createMaterial(
						new THREE.MeshBasicMaterial( { map: mat } ),friction, .9 // low restitution
					);
					// Ground
					ground = new Physijs.BoxMesh(new THREE.BoxGeometry(1050, 1, 1050),ground_material,0 // mass
					);

					scene.add( ground );
					//walls
					var wall_material = Physijs.createMaterial(
						new THREE.MeshBasicMaterial( { color: 0x00ff00 } ),friction, .9 // low restitution
					);
					var wallHeight=50;
					var wallLength=1050;
					var wall1 = new Physijs.BoxMesh(new THREE.BoxGeometry(wallLength, wallHeight, 15),wall_material,0 // mass
					);

					wall1.position.y=wallHeight/2;
					wall1.position.z=wallLength/2;
					scene.add( wall1 );
					var wall2 = new Physijs.BoxMesh(new THREE.BoxGeometry(wallLength, wallHeight, 15),wall_material,0 // mass
					);

					wall2.position.y=wallHeight/2;
					wall2.position.z=-wallLength/2;
					scene.add( wall2 );
					var wall3 = new Physijs.BoxMesh(new THREE.BoxGeometry(15, wallHeight, wallLength),wall_material,0 // mass
					);

					wall3.position.y=wallHeight/2;
					wall3.position.x=-wallLength/2;
					scene.add( wall3 );
					var wall4 = new Physijs.BoxMesh(new THREE.BoxGeometry(15, wallHeight, wallLength),wall_material,0 // mass
					);

					wall4.position.y=wallHeight/2;
					wall4.position.x=wallLength/2;
					scene.add( wall4 );


					}









				// if(fogEffect){
				// 	scene.fog=new THREE.Fog(0xffffff,5,200);
				// }

				//creates SpotLight for initial car position
				var spotLight=new THREE.SpotLight(0xffffff,5);
				spotLight.position.set(-40,60,40);
				spotLight.castShadow=true;
				scene.add(spotLight);

				//adds general light to screen
				var ambiLight=new THREE.AmbientLight(0xffffff);
				scene.add(ambiLight);






//	var controls=new THREE.OrbitControls(camera,renderer.domElement);
	//controls.lookSpeed=0.05;
	//controls.movementSpeed=30;


	//function to create Truck , very heavy function , just go through it
	function createTruck(){
	var sphereGeo1=new THREE.SphereGeometry(10,20,20);
	var sphereMat1=new THREE.MeshLambertMaterial({color:0xfff000});
	var mesh1=new THREE.Mesh(sphereGeo1,sphereMat1);


	var sphereMat2=new THREE.MeshLambertMaterial({color:0xff0000});
	var mesh2=new THREE.Mesh(sphereGeo1,sphereMat2);
	mesh2.position.x=9;


	var sphereMat3=new THREE.MeshLambertMaterial({color:0x000fff});
	var mesh3=new THREE.Mesh(sphereGeo1,sphereMat3);
	mesh3.position.x=-9;


	var sphere1BSP=new ThreeBSP(mesh1);
	var sphere2BSP=new ThreeBSP(mesh2);
	var sphere3BSP=new ThreeBSP(mesh3);

	//above code creates wheels of car

	var loader=new THREE.TextureLoader();
	var material=loader.load('textures/index.jpeg');

	var resultBSP=sphere1BSP.subtract(sphere2BSP).subtract(sphere3BSP);

	var resultMesh=resultBSP.toMesh();

	//material for car ,can change this if we'd like to something else , just change the image file 6 lines up. Make sure image is in texture folder
	resultMesh.material=new THREE.MeshBasicMaterial({map:material});
	resultMesh.geometry.computeFaceNormals();
	resultMesh.geometry.computeVertexNormals();

	//creates general geometry which we will use for car
	var geom=new THREE.Geometry();
	//truckBody
	var truckBody_mesh=new THREE.Mesh(new THREE.CubeGeometry(100,30,40),new THREE.MeshLambertMaterial({color:0xff0000}));
	truckBody_mesh.updateMatrix();
	geom.merge(truckBody_mesh.geometry,truckBody_mesh.matrix);


	var truckBody_Front=new THREE.Mesh(new THREE.CubeGeometry(25,15,40),new THREE.MeshLambertMaterial({map:material}));

	truckBody_Front.position.x=62.5;
	truckBody_Front.position.y=-7.5;
	truckBody_Front.updateMatrix();
	geom.merge(truckBody_Front.geometry,truckBody_Front.matrix);

	var wheel1_Mesh=new THREE.Mesh(resultMesh.geometry,resultMesh.material);
	wheel1_Mesh.position.x=65;
	wheel1_Mesh.position.y=-15;
	wheel1_Mesh.position.z=20;
	wheel1_Mesh.rotation.y=Math.PI/2;
	wheel1_Mesh.updateMatrix();
	geom.merge(wheel1_Mesh.geometry,wheel1_Mesh.matrix);

	var wheel2_Mesh=new THREE.Mesh(resultMesh.geometry,resultMesh.material);
	wheel2_Mesh.position.x=65;
	wheel2_Mesh.position.y=-15;
	wheel2_Mesh.position.z=-20;
	wheel2_Mesh.rotation.y=Math.PI/2;
	wheel2_Mesh.updateMatrix();
	geom.merge(wheel2_Mesh.geometry,wheel2_Mesh.matrix);

	var wheel3_Mesh=new THREE.Mesh(resultMesh.geometry,resultMesh.material);
	wheel3_Mesh.position.x=-40;
	wheel3_Mesh.position.y=-15;
	wheel3_Mesh.position.z=20;
	wheel3_Mesh.rotation.y=Math.PI/2;
	wheel3_Mesh.updateMatrix();
	geom.merge(wheel3_Mesh.geometry,wheel3_Mesh.matrix);

	var wheel4_Mesh=new THREE.Mesh(resultMesh.geometry,resultMesh.material);
	wheel4_Mesh.position.x=-40;
	wheel4_Mesh.position.y=-15;
	wheel4_Mesh.position.z=-20;
	wheel4_Mesh.rotation.y=Math.PI/2;
	wheel4_Mesh.updateMatrix();
	geom.merge(wheel4_Mesh.geometry,wheel4_Mesh.matrix);

	//creates physics car
	var truck=new Physijs.BoxMesh(geom,resultMesh.material);
	//var truck=new THREE.Mesh(geom,resultMesh.material,0.1,10);
	truck.position.y=30;
	//truck.scale.set(0.5,0.5,0.5);
	scene.add(truck);
	return truck;
}



//used in the update function
var step=0;
var n_truck_t;
var num=0;
var firstTime=1;

	function update(){
		step+=1;

//allows to add scene once
		if(firstTime){

			createLand();
			n_truck_t=createTruck();
			n_truck_t.add(camera);
			firstTime=0;
		}

		//can be used as our timer
		if(step==1000 && n_truck_t.position.x!=n_truck_t.position.x+1){
			//alert("Game Over");
		}


		//calls the function that moves the car
		moveTruck();
		//calls change camera orientation function
		change_cam_orientation();

		//controls.update();
		scene.simulate();


	}
		//animate function loop
		function animate(){
			update();
			renderer.render(scene,camera);
			requestAnimationFrame(animate);
		}
		var move_left,move_right,move_up,move_down,pause;
		var x=0;//allows for space bar to slow down car
		var change_cam_angle;
		var y_axis=new THREE.Vector3(0,1,0);

		function change_cam_orientation(){
			if(change_cam_angle){
				camera.position.x=200;
				camera.position.y=100;
				camera.position.z=200;
				camera.lookAt(n_truck_t.position);
			}
			else{
				camera.position.x=-140;
				camera.position.y=50;
				camera.position.z=0;
				camera.rotation.y=-Math.PI/2;
				camera.lookAt(n_truck_t.position);
			}
		}



		function moveTruck(){

			if(move_left){
			rot=new THREE.Quaternion().setFromAxisAngle(y_axis,Math.PI/120);
			cur=n_truck_t.quaternion;
			cur.multiplyQuaternions(rot,cur);
			n_truck_t.__dirtyRotation=true;
			}
			else if(move_right){
				rot=new THREE.Quaternion().setFromAxisAngle(y_axis,-Math.PI/120);
				cur=n_truck_t.quaternion;
				cur.multiplyQuaternions(rot,cur);
				n_truck_t.__dirtyRotation=true;
			}
			else if(move_up){
				var curr_rotation=new THREE.Matrix4().extractRotation(n_truck_t.matrix);
				//console.log(curr_rotation);
				var force_vector=new THREE.Vector3(500000,0,0).applyMatrix4(curr_rotation);
				//console.log(force_vector);
				n_truck_t.applyCentralImpulse(force_vector);
				n_truck_t.__dirtyPosition=true;
				x=0;
			}
			else if(move_down){
				var curr_rotation=new THREE.Matrix4().extractRotation(n_truck_t.matrix);
				var force_vector=new THREE.Vector3(-500000,0,0).applyMatrix4(curr_rotation);
				n_truck_t.applyCentralImpulse(force_vector);
				n_truck_t.__dirtyPosition=true;
				x=1;
			}
			else if(pause){
				if(x==0){
				var curr_rotation=new THREE.Matrix4().extractRotation(n_truck_t.matrix);
				var force_vector=new THREE.Vector3(-500000,0,0).applyMatrix4(curr_rotation);
				n_truck_t.applyCentralImpulse(force_vector);
				n_truck_t.__dirtyPosition=true;
			}
			else if(x==1){
				var curr_rotation2=new THREE.Matrix4().extractRotation(n_truck_t.matrix);
				//console.log(curr_rotation);
				var force_vector2=new THREE.Vector3(500000,0,0).applyMatrix4(curr_rotation2);
				//console.log(force_vector);
				n_truck_t.applyCentralImpulse(force_vector2);
				n_truck_t.__dirtyPosition=true;
			}
			}
		}
		document.addEventListener('keydown',function(event){
			var code=event.keyCode;
			//move_left=0;move_right=0;move_up=0;move_down=0;pause=0;
			if(code==37){
				move_left=1;
			}
			if(code==38){
				move_up=1;
			}
			if(code==39){
				move_right=1;
			}
			if(code==40){
				move_down=1;
			}
			if(code==32){
				pause=1;
			}
			if(code==27){
				change_cam_angle=1;
			}
		});

		document.addEventListener('keyup',function(event){
			var code=event.keyCode;
			//move_left=1;move_right=1;move_up=1;move_down=1;pause=0;
			if(code==37){
				move_left=0;
			}
			if(code==38){
				move_up=0;
			}
			if(code==39){
				move_right=0;
			}
			if(code==40){
				move_down=0;
			}
			if(code==32){
				pause=0;
			}
			if(code==27){
				change_cam_angle=0;
			}
		});

requestAnimationFrame(animate);
		</script>
	</body>
</html>
