<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<style>
			body { margin: 0; }

		</style>
	</head>
	<body>

		<script src="js/three.js"></script>

		<script src="js/FirstPersonControls.js"></script>
		<script src="js/physi.js"></script>
		<script src="js/GLTFLoader.js"></script>
		<script src="js/perlin_noise.js"></script>
		<script src="js/ammo.js"></script>
		<script src="js/THREEBSP.js"></script>

		<script>

			Physijs.scripts.worker='js/physijs_worker.js';
			//Physijs.scripts.ammo='ammo.js';

			var scene=new Physijs.Scene;

			scene.setGravity(new THREE.Vector3(0,-10,0));
				//var scene=new THREE.Scene();
				//scene.background=new THREE.Color(0xdddddd);

				var camera=new THREE.PerspectiveCamera(40,window.innerWidth/window.innerHeight,0.1,1000);
				camera.rotation.y=-Math.PI/2;
				camera.position.x=-160;
				camera.position.y=50;

				camera.lookAt(scene.position);

				var fogEffect=0;




				 var renderer=new THREE.WebGLRenderer({antialias:true});
				renderer.setSize(window.innerWidth,window.innerHeight);
				renderer.setClearColor(0x0fffff);
				document.body.appendChild(renderer.domElement);
				window.addEventListener('resize',()=>{
					renderer.setSize( window.innerWidth, window.innerHeight );
				 	camera.aspect=window.innerWidth / window.innerHeight;
				 	camera.updateProjectionMatrix();
				});

				function add_sphere(){
					var sphereGeometry=new THREE.SphereGeometry(1,20,20);
					var load=new THREE.TextureLoader();
					var mat=load.load('textures/crate.gif');

					var sphereMat=new THREE.MeshBasicMaterial({map:mat});
					var sphere=new Physijs.BoxMesh(sphereGeometry,sphereMat);
					sphere.scale.set(5,5,5);
					sphere.position.x=150*Math.random();
					sphere.position.y=100;
					sphere.__dirtyPosition=true;
					scene.add(sphere);
				}

				function createLand(){
					var loader=new THREE.TextureLoader();
					var material=loader.load('textures/road.jpg');
					var gmaterial=new THREE.MeshBasicMaterial({map:material});
					//var gmaterial= Physijs.createMaterial(new THREE.MeshBasicMaterial({map:material,side:THREE.DoubleSide}),0.1,10);
					var ground =new THREE.PlaneGeometry(1200,1000,100,100);
					for(var i=0;i<ground.vertices.length;i++){
						var vertex=ground.vertices[i];

					value=noise.simplex2(vertex.x/10000,vertex.y/10000);
					vertex.z=Math.abs(value)*1;



					}
					ground.computeFaceNormals();
					ground.computeVertexNormals();

					var groundObj=new Physijs.BoxMesh(ground,gmaterial,0,100,100);

					groundObj.rotation.x=Math.PI/-2;
					scene.add(groundObj);
					return groundObj;

					}

					function add_cut_up_sphere(){
						var sphereGeo1=new THREE.SphereGeometry(10,20,20);
						var sphereMat1=new THREE.MeshBasicMaterial({color:0xfff000});
						var mesh1=new Physijs.BoxMesh(sphereGeo1,sphereMat1);
						//mesh1.scale.set(2,2,2);
						mesh1.position.y=100;
						mesh1.position.x=100;
						mesh1.position.z=-100;
						mesh1.scale.set(4,4,4);
						//mesh1.position.y=45;
						scene.add(mesh1);

						return mesh1;
					}






				if(fogEffect){
					scene.fog=new THREE.Fog(0xffffff,5,200);
				}


				var spotLight=new THREE.SpotLight(0xffffff,5);
				spotLight.position.set(-40,60,40);
				spotLight.castShadow=true;
				scene.add(spotLight);

				var ambiLight=new THREE.AmbientLight(0xffffff);
				scene.add(ambiLight);



					//var AnaglyphEffect=new THREE.AnaglyphEffect(renderer);
					//AnaglyphEffect.setSize(window.innerWidth,window.innerHeight);


//	var controls=new THREE.FirstPersonControls(camera,renderer.domElement);
	//controls.lookSpeed=0.05;
	//controls.movementSpeed=30;
function createTruck(){
	var sphereGeo1=new THREE.SphereGeometry(10,20,20);
	var sphereMat1=new THREE.MeshLambertMaterial({color:0xfff000});
	var mesh1=new THREE.Mesh(sphereGeo1,sphereMat1);
	//scene.add(mesh1);

	var sphereMat2=new THREE.MeshLambertMaterial({color:0xff0000});
	var mesh2=new THREE.Mesh(sphereGeo1,sphereMat2);
	mesh2.position.x=9;
	//scene.add(mesh2);

	var sphereMat3=new THREE.MeshLambertMaterial({color:0x000fff});
	var mesh3=new THREE.Mesh(sphereGeo1,sphereMat3);
	mesh3.position.x=-9;
	//scene.add(mesh3);

	var sphere1BSP=new ThreeBSP(mesh1);
	var sphere2BSP=new ThreeBSP(mesh2);
	var sphere3BSP=new ThreeBSP(mesh3);

	var loader=new THREE.TextureLoader();
	var material=loader.load('textures/index.jpeg');

	var resultBSP=sphere1BSP.subtract(sphere2BSP).subtract(sphere3BSP);

	var resultMesh=resultBSP.toMesh();
	resultMesh.material=new THREE.MeshLambertMaterial({map:material});
	resultMesh.geometry.computeFaceNormals();
	resultMesh.geometry.computeVertexNormals();
	//resultMesh.position.y=-30;//result mesh is the wheel
	//scene.add(resultMesh);

	var geom=new THREE.Geometry();
	var truckBody_mesh=new THREE.Mesh(new THREE.CubeGeometry(100,30,40),new THREE.MeshLambertMaterial({color:0xff0000}));
	truckBody_mesh.updateMatrix();
	geom.merge(truckBody_mesh.geometry,truckBody_mesh.matrix);


	var truckBody_Front=new THREE.Mesh(new THREE.CubeGeometry(25,15,40),new THREE.MeshLambertMaterial({map:material}));

	truckBody_Front.position.x=62.5;
	truckBody_Front.position.y=-7.5;
	truckBody_Front.updateMatrix();
	geom.merge(truckBody_Front.geometry,truckBody_Front.matrix);

	var wheel1_Mesh=new THREE.Mesh(resultMesh.geometry,resultMesh.material);
	wheel1_Mesh.position.x=65;
	wheel1_Mesh.position.y=-15;
	wheel1_Mesh.position.z=20;
	wheel1_Mesh.rotation.y=Math.PI/2;
	wheel1_Mesh.updateMatrix();
	geom.merge(wheel1_Mesh.geometry,wheel1_Mesh.matrix);

	var wheel2_Mesh=new THREE.Mesh(resultMesh.geometry,resultMesh.material);
	wheel2_Mesh.position.x=65;
	wheel2_Mesh.position.y=-15;
	wheel2_Mesh.position.z=-20;
	wheel2_Mesh.rotation.y=Math.PI/2;
	wheel2_Mesh.updateMatrix();
	geom.merge(wheel2_Mesh.geometry,wheel2_Mesh.matrix);

	var wheel3_Mesh=new THREE.Mesh(resultMesh.geometry,resultMesh.material);
	wheel3_Mesh.position.x=-40;
	wheel3_Mesh.position.y=-15;
	wheel3_Mesh.position.z=20;
	wheel3_Mesh.rotation.y=Math.PI/2;
	wheel3_Mesh.updateMatrix();
	geom.merge(wheel3_Mesh.geometry,wheel3_Mesh.matrix);

	var wheel4_Mesh=new THREE.Mesh(resultMesh.geometry,resultMesh.material);
	wheel4_Mesh.position.x=-40;
	wheel4_Mesh.position.y=-15;
	wheel4_Mesh.position.z=-20;
	wheel4_Mesh.rotation.y=Math.PI/2;
	wheel4_Mesh.updateMatrix();
	geom.merge(wheel4_Mesh.geometry,wheel4_Mesh.matrix);


	var truck=new Physijs.BoxMesh(geom,resultMesh.material);
	//var truck=new THREE.Mesh(geom,resultMesh.material,0.1,10);
	truck.position.y=30;
	//truck.scale.set(0.5,0.5,0.5);
	scene.add(truck);
	return [truck,wheel1_Mesh];
	//requestAnimationFrame(animate);
}




var step=0;
var n_truck_t;
var num=0;

var clock=new THREE.Clock();


var firstTime=1;

	function update(){
		step+=1;

		var speed=Date.now()*0.00025;
		var delta=clock.getDelta();


		if(firstTime){
			createLand();
			//add_cut_up_sphere();
			values=createTruck();
			n_truck_t=values[0];
			n_truck_t.add(camera);
			firstTime=0;
		}


		if(step==1000 && n_truck_t.position.x!=n_truck_t.position.x+1){
			//alert("Game Over");
		}

		if(num%50==0){
			//add_sphere();
		}
		/*if(step%500==0){
			n_truck_t.setLinearVelocity(new THREE.Vector3(50,0,0));
		}*/

		moveTruck();
		change_cam_orientation();

		//controls.update(delta);
		scene.simulate();


	}

		function animate(){
			update();
			renderer.render(scene,camera);
			requestAnimationFrame(animate);
		}
		var move_left,move_right,move_up,move_down,pause;
		var x=0;//allows for space bar to slow down car
		var change_cam_angle;
		var y_axis=new THREE.Vector3(0,1,0);

		function change_cam_orientation(){
			if(change_cam_angle){
				camera.position.x=200;
				camera.position.y=100;
				camera.position.z=200;
				camera.lookAt(scene.position);
			}
			else{
				camera.position.x=-140;
				camera.position.y=50;
				camera.position.z=0;
				camera.rotation.y=-Math.PI/2;
				camera.lookAt(n_truck_t.position);
			}
		}



		function moveTruck(){

			if(move_left){
			rot=new THREE.Quaternion().setFromAxisAngle(y_axis,Math.PI/120);
			cur=n_truck_t.quaternion;
			cur.multiplyQuaternions(rot,cur);
			n_truck_t.__dirtyRotation=true;
			}
			else if(move_right){
				rot=new THREE.Quaternion().setFromAxisAngle(y_axis,-Math.PI/120);
				cur=n_truck_t.quaternion;
				cur.multiplyQuaternions(rot,cur);
				n_truck_t.__dirtyRotation=true;
			}
			else if(move_up){
				var curr_rotation=new THREE.Matrix4().extractRotation(n_truck_t.matrix);
				//console.log(curr_rotation);
				var force_vector=new THREE.Vector3(500000,0,0).applyMatrix4(curr_rotation);
				//console.log(force_vector);
				n_truck_t.applyCentralImpulse(force_vector);
				n_truck_t.__dirtyPosition=true;
				x=0;
			}
			else if(move_down){
				var curr_rotation=new THREE.Matrix4().extractRotation(n_truck_t.matrix);
				var force_vector=new THREE.Vector3(-500000,0,0).applyMatrix4(curr_rotation);
				n_truck_t.applyCentralImpulse(force_vector);
				n_truck_t.__dirtyPosition=true;
				x=1;
			}
			else if(pause){
				if(x==0){
				var curr_rotation=new THREE.Matrix4().extractRotation(n_truck_t.matrix);
				var force_vector=new THREE.Vector3(-500000,0,0).applyMatrix4(curr_rotation);
				n_truck_t.applyCentralImpulse(force_vector);
				n_truck_t.__dirtyPosition=true;
			}
			else if(x==1){
				var curr_rotation2=new THREE.Matrix4().extractRotation(n_truck_t.matrix);
				//console.log(curr_rotation);
				var force_vector2=new THREE.Vector3(500000,0,0).applyMatrix4(curr_rotation2);
				//console.log(force_vector);
				n_truck_t.applyCentralImpulse(force_vector2);
				n_truck_t.__dirtyPosition=true;
			}
			}
		}
		document.addEventListener('keydown',function(event){
			var code=event.keyCode;
			//move_left=0;move_right=0;move_up=0;move_down=0;pause=0;
			if(code==37){
				move_left=1;
			}
			if(code==38){
				move_up=1;
			}
			if(code==39){
				move_right=1;
			}
			if(code==40){
				move_down=1;
			}
			if(code==32){
				pause=1;
			}
			if(code==27){
				change_cam_angle=1;
			}
		});

		document.addEventListener('keyup',function(event){
			var code=event.keyCode;
			//move_left=1;move_right=1;move_up=1;move_down=1;pause=0;
			if(code==37){
				move_left=0;
			}
			if(code==38){
				move_up=0;
			}
			if(code==39){
				move_right=0;
			}
			if(code==40){
				move_down=0;
			}
			if(code==32){
				pause=0;
			}
			if(code==27){
				change_cam_angle=0;
			}
		});

requestAnimationFrame(animate);
		</script>
	</body>
</html>
